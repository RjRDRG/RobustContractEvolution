# -*- coding: utf-8 -*-

import json

from typing import List, Tuple, Optional

from proxy.http.proxy import HttpProxyBasePlugin
from proxy.http.parser import HttpParser, httpParserTypes

class AdapterPlugin(HttpProxyBasePlugin):

    DEFAULT_CHUNKS = [
        b'modify',
        b'chunk',
        b'response',
        b'plugin',
    ]

    def __init__(self, *args: any, **kwargs: any) -> None:
        super().__init__(*args, **kwargs)
        self.response = HttpParser(httpParserTypes.RESPONSE_PARSER)
        self.requests = []

    def before_upstream_connection(
            self, request: HttpParser,
    ) -> Optional[HttpParser]:
        return self.handle_service_request(request)

    def handle_client_request(
            self, request: HttpParser,
    ) -> Optional[HttpParser]:
        self.requests.append(request)
        return self.handle_service_request(request)

    def handle_upstream_chunk(self, chunk: memoryview) -> Optional[memoryview]:
        self.response.parse(chunk)
        if self.response.is_complete:
            request = requests.pop(0)
            if self.response.is_chunked_encoded:
                self.response.body = b'\n'.join(self.DEFAULT_CHUNKS) + b'\n'
            self.client.queue(memoryview(self.response.build_response()))
        return None

    def handle_service_request(
        self, request: HttpParser,
    ) -> Optional[HttpParser]:
        if request.path:
            endpoint = request.path.decode().split("?")[0].split("/")
            endpoint = list(filter(None, endpoint))
            if request.method:
                endpoint.append(request.method.decode().lower())
            match endpoint:
#ENDPOINT_REQUEST_CASES
        return request

#ENDPOINT_REQUEST_HANDLERS

    def build_query_dictionary(
        self, request: HttpParser,
    ) -> dict[str, str]:
        if request.path:
            aux = request.path.decode().split("?")
            if len(aux) < 2:
                return dict()
            aux = aux[1].split("&")
            aux = list(filter(None, aux))
            query = dict()
            for q in aux:
                query[q.split("=")[0]] = q.split("=")[1]
            return query
        else:
            return dict()

    def build_json_body_dictionary(
        self, request: HttpParser,
    ):
        body = dict()
        if request.body:
            body = json.loads(request.body)
        return body

    def get_header(
        self, headerKey: str, request: HttpParser,
    ) -> str:
        if request.headers:
            aux = request.headers.get(headerKey.encode())
            if aux:
                return aux[1].decode()
            else:
                raise Exception()
        else:
            raise Exception()

